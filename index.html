<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>sweet&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="sweet&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="sweet&#39;s blog">
<meta property="article:author" content="ZTT">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="sweet&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">sweet&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CS-lab1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/13/CS-lab1/" class="article-date">
  <time datetime="2020-01-13T09:24:46.000Z" itemprop="datePublished">2020-01-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OS-LAB/">OS_LAB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/13/CS-lab1/">nasm&amp;c++ 读取FAT12文件系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="FAT12文件系统">FAT12文件系统</h2>
<h3 id="基本结构">基本结构</h3>
<ul>
<li>
<p>FAT文件系统把存储介质看成一位的数组，基本单位是簇。</p>
</li>
<li>
<p>一个簇包含一个扇区，大小为512B</p>
</li>
<li>
<p>存储介质划分为3个区域：boot，FAT，directory and data area</p>
</li>
<li>
<img src="https://img-blog.csdnimg.cn/20200113213415437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzI0MjgzNg==,size_16,color_FFFFFF,t_70" alt="图片1" style="zoom:40%;" />
</li>
</ul>
<h3 id="引导扇区BOOT">引导扇区BOOT</h3>
<table>
<thead>
<tr>
<th>BS_jmpBOOT</th>
<th>0</th>
<th>3</th>
<th>一个短跳转指令</th>
<th>jmp short LABEL_STARTnop</th>
</tr>
</thead>
<tbody>
<tr>
<td>BS_OEMName</td>
<td>3</td>
<td>8</td>
<td>厂商名</td>
<td>‘ZGH’</td>
</tr>
<tr>
<td>BPB_BytesPerSec</td>
<td>11</td>
<td>2</td>
<td>每扇区字节数（Bytes/Sector）</td>
<td>0x200</td>
</tr>
<tr>
<td>BPB_SecPerClus</td>
<td>13</td>
<td>1</td>
<td>每簇扇区数（Sector/Cluster）</td>
<td>0x1</td>
</tr>
<tr>
<td>BPB_ResvdSecCnt</td>
<td>14</td>
<td>2</td>
<td>Boot记录占用多少扇区</td>
<td>ox1</td>
</tr>
<tr>
<td>BPB_NumFATs</td>
<td>16</td>
<td>1</td>
<td>共有多少FAT表</td>
<td>0x2</td>
</tr>
<tr>
<td>BPB_RootEntCnt</td>
<td>17</td>
<td>2</td>
<td>根目录区文件最大数</td>
<td>0xE0</td>
</tr>
<tr>
<td>BPB_TotSec16</td>
<td>19</td>
<td>2</td>
<td>扇区总数</td>
<td>0xB40</td>
</tr>
<tr>
<td>BPB_Media</td>
<td>21</td>
<td>1</td>
<td>介质描述符</td>
<td>0xF0</td>
</tr>
<tr>
<td>BPB_FATSz16</td>
<td>22</td>
<td>2</td>
<td>每个FAT表所占扇区数</td>
<td>0x9</td>
</tr>
<tr>
<td>BPB_SecPerTrk</td>
<td>24</td>
<td>2</td>
<td>每磁道扇区数（Sector/track）</td>
<td>0x12</td>
</tr>
<tr>
<td>BPB_NumHeads</td>
<td>26</td>
<td>2</td>
<td>磁头数（面数）</td>
<td>0x2</td>
</tr>
<tr>
<td>BPB_HiddSec</td>
<td>28</td>
<td>4</td>
<td>隐藏扇区数</td>
<td>0</td>
</tr>
<tr>
<td>BPB_TotSec32</td>
<td>32</td>
<td>4</td>
<td>如果BPB_TotSec16=0,则由这里给出扇区数</td>
<td>0</td>
</tr>
<tr>
<td>BS_DrvNum</td>
<td>36</td>
<td>1</td>
<td>INT 13H的驱动器号</td>
<td>0</td>
</tr>
<tr>
<td>BS_Reserved1</td>
<td>37</td>
<td>1</td>
<td>保留，未使用</td>
<td>0</td>
</tr>
<tr>
<td>BS_BootSig</td>
<td>38</td>
<td>1</td>
<td>扩展引导标记(29h)</td>
<td>0x29</td>
</tr>
<tr>
<td>BS_VolID</td>
<td>39</td>
<td>4</td>
<td>卷序列号</td>
<td>0</td>
</tr>
<tr>
<td>BS_VolLab</td>
<td>43</td>
<td>11</td>
<td>卷标</td>
<td>‘ZGH’</td>
</tr>
<tr>
<td>BS_FileSysType</td>
<td>54</td>
<td>8</td>
<td>文件系统类型</td>
<td>‘FAT12’</td>
</tr>
<tr>
<td>引导代码及其他内容</td>
<td>62</td>
<td>448</td>
<td>引导代码及其他数据</td>
<td>引导代码（剩余空间用0填充）</td>
</tr>
<tr>
<td>结束标志0xAA55</td>
<td>510</td>
<td>2</td>
<td>第510字节为0x55，第511字节为0xAA</td>
<td>0xAA55</td>
</tr>
</tbody>
</table>
<h3 id="FAT-File-Allocation-Table">FAT-File Allocation Table</h3>
<ul>
<li>
<p>FAT1和FAT2互为备份。</p>
</li>
<li>
<p>每12位成为一个FAT项(FATEntry)，代表一个簇。所以2个FAT项会占用3个字节</p>
</li>
<li>
<p>数据区起始于簇2,why?</p>
<p>-在1.44M软盘上，FAT前三个字节的值是固定的0xF0、0xFF、0xFF，用于表示这是一个应用在1.44M软盘上的FAT12文件系统。本来序号为0和1的FAT表项应该对应于簇0和簇1，但是由于这两个表项被设置成了固定值，簇0和簇1就没有存在的意义.</p>
</li>
<li>
<p>FAT项的值代表文件的下一个簇号</p>
<ul>
<li>值为0xFF7，表示坏簇</li>
<li>值大于或等于0xFF8，表示当前簇是本文件的最后一个簇</li>
</ul>
</li>
<li>
<p><img src="https://img-blog.csdnimg.cn/20200113213536221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzI0MjgzNg==,size_16,color_FFFFFF,t_70" alt=""></p>
</li>
</ul>
<h3 id="根目录区">根目录区</h3>
<ul>
<li>根目录区由目录项组成，一个目录项占32个字节。</li>
<li><img src="https://img-blog.csdnimg.cn/20200113213526412.gif" alt=""></li>
</ul>
<h2 id="g-与nasm混合编程">g++与nasm混合编程</h2>
<ul>
<li>
<p>环境ubuntu64，安装g++,nasm</p>
</li>
<li>
<p>my_print.asm负责输出，1.cpp为主文件</p>
</li>
<li>
<p>1.cpp中首先声明函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">void</span> <span class="title">my_print</span><span class="params">(<span class="keyword">char</span> *, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>my_print.asm定义函数，注意用global my_print声明函数名。</p>
</li>
<li>
<p>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nasm -f elf32 my_print.asm</span><br><span class="line">$ g++ -o fat -m32 1.cpp my_print.o</span><br><span class="line">$ .&#x2F;fat</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="如何读取FAT12文件？">如何读取FAT12文件？</h2>
<h3 id="Steps">Steps</h3>
<ol>
<li>
<p>读取Boot，得到必要的参数：</p>
<ul>
<li>BPB_BytsPerSec <em>每扇区字节数</em></li>
<li>BPB_SecPerClus <em>每簇扇区数</em></li>
<li>BPB_RsvdSecCnt <em>Boot记录占用的扇区数</em></li>
<li>BPB_NumFATs  <em>FAT表个数</em></li>
<li>BPB_RootEntCnt <em>根目录最大文件数</em></li>
<li>BPB_TotSec16 <em>FAT扇区数，如果该值为0，则BPB_FATSz32为FAT扇区数</em></li>
<li>BPB_HiddSec</li>
</ul>
</li>
<li>
<p>计算每簇的字节数，每个区域的初始位置的偏移量。</p>
<ul>
<li>每簇字节数=每簇扇区数*每扇区字节数。</li>
<li>fatBase=Boot记录占用的扇区数*每扇区字节数</li>
<li>fileRootBase=（Boot记录占用的扇区数+FAT表个数* FAT扇区数）*每扇区字节数</li>
<li>dataBase=（Boot记录占用的扇区数+FAT表个数* FAT扇区数+（根目录最大文件数* 32+每扇区字节数-1）/每扇区字节数）*每扇区字节数。</li>
</ul>
<p>数据区的偏移量又乘又除是不是吃饱了撑的0.0？可不可以等于fileRootBase+根目录最大文件数*32？不阔以！</p>
<p>dataBase初始位置=FileRootBase最后一个簇的结束位置。如果根目录没有填满最后一个簇，数据区也是从下一个簇开始的，而不是默认于最后一个根目录的结束位置开始。</p>
<p>用 <em><em>（根目录最大文件数</em> 32+每扇区字节数-1）/每扇区字节数</em>* 可以得到根目录区占用的真正扇区数。</p>
</li>
<li>
<p>广搜遍历Fat12文件系统</p>
<ul>
<li>首先读取根目录区</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>判断文件属性</p>
<ul>
<li>
<p>目录项的属性记录了该项是文件夹or文件</p>
<ul>
<li>用DIR_Attr&amp;0x10判断，结果为0是文件，否则为文件夹。</li>
</ul>
</li>
<li>
<p>处理文件夹</p>
<ul>
<li>
<p>得到下一层目录的数据区初始位置，首先需要FAT号。文件夹的目录项中DIR_FstClus记录了文件夹FAT号(num)，其内容即为所需FAT号。</p>
<ul>
<li>
<p>FAT项大小为12位。</p>
</li>
<li>
<p>从fatBase <strong>+</strong> num ***** 3 <strong>/</strong> 2读取2个字节（16位）。结合存储的小尾顺序和FAT项结构可以得到。num为偶去掉高4位,num为奇去掉低4位。</p>
</li>
<li>
<p>(num &amp; 1) ? (bytes &gt;&gt; 4) : (bytes &amp; ((1 &lt;&lt; 12) - 1))为下一个FAT号</p>
</li>
</ul>
</li>
<li>
<p>用FAT号计算在数据区中的位置。</p>
<ul>
<li>startByte <strong>=</strong> dataBase <strong>+</strong> (fat号- 2) ***** BytsPerClus;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>处理普通文件</p>
<ul>
<li>如果文件在数据区中需要多个簇，那么用上面的办法读取数据。</li>
</ul>
</li>
<li>
<p>广搜遍历</p>
<ul>
<li>分层遍历</li>
<li>每一层的文件夹放进队列。
<ul>
<li>队列为空则停止</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="用文件名查询特定文件">用文件名查询特定文件</h2>
<ol>
<li>对于目录项中的文件名做处理，去除非法字符和空格。如果是普通文件，第一个空格为‘.’。</li>
<li>判断文件名是否相等，strcmp等等各种方法都可。</li>
</ol>
<h2 id="制作FAT镜像">制作FAT镜像</h2>
<ol>
<li>
<p>创建新的软盘镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat -C a.img 1440</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>挂载点，可以创建一个新的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir 文件名</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>将镜像挂载到挂载点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount a.img 文件名</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>挂载后，就可以通过操作./mount文件夹，来向a.img加入和查看文件。可使用系统自带的资源管理器类似 GUI工具，或者使用命令行操作。</p>
</li>
</ol>
<h2 id="我的呆码👉-click-me">我的呆码👉  <a href="https://github.com/emsweet/OS_LAB/tree/master/lab1" target="_blank" rel="noopener">click me</a></h2>
<p>支持ls，cat 文件名，ls -l[lll] [文件名],ls [文件名] -l[lll] .</p>
<p><img src="https://img-blog.csdnimg.cn/20200113213616253.png" alt="image-20200113204622190"></p>
<p><img src="https://img-blog.csdnimg.cn/20200113213625585.png" alt="在这里插入图片描述"></p>
<img src="https://img-blog.csdnimg.cn/20200113213635556.png" alt="在这里插入图片描述" />
<img src="https://img-blog.csdnimg.cn/2020011321364255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzI0MjgzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:80%;" />
<h2 id="reference">reference</h2>
<p><a href="https://blog.csdn.net/qq_39654127/article/details/88429461#main-toc" target="_blank" rel="noopener">https://blog.csdn.net/qq_39654127/article/details/88429461#main-toc</a></p>
<p><a href="https://blog.csdn.net/judyge/article/details/52373751" target="_blank" rel="noopener">https://blog.csdn.net/judyge/article/details/52373751</a></p>
<p><a href="https://blog.csdn.net/yxc135/article/details/8769086" target="_blank" rel="noopener">https://blog.csdn.net/yxc135/article/details/8769086</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/13/CS-lab1/" data-id="ck5dd6h4h00033kvxcjyp9a3f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/2020-1/" rel="tag">2020/1</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OS-LAB/" rel="tag">OS_LAB</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/13/hello/" class="article-date">
  <time datetime="2020-01-13T08:21:11.000Z" itemprop="datePublished">2020-01-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/13/hello/">hi this is sweet&#39;s blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>欢迎来本甜的博客，从今天开始，这里将记录我的学习日记。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/13/hello/" data-id="ck5dd6h4300003kvx0y474km3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OS-LAB/">OS_LAB</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2020-1/" rel="tag">2020/1</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS-LAB/" rel="tag">OS_LAB</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/2020-1/" style="font-size: 10px;">2020/1</a> <a href="/tags/OS-LAB/" style="font-size: 10px;">OS_LAB</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/13/CS-lab1/">nasm&amp;c++ 读取FAT12文件系统</a>
          </li>
        
          <li>
            <a href="/2020/01/13/hello/">hi this is sweet&#39;s blog</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 ZTT<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>